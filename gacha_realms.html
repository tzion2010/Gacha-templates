<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Gacha Realms â€” Advanced Mode</title>
<style>
  :root{
    --bg:#0b0f17;
    --panel:#111827;
    --panel-2:#0f1420;
    --text:#e5e7eb;
    --muted:#94a3b8;
    --accent:#6ee7ff;
    --good:#22c55e;
    --bad:#ef4444;
    --btn:#1f2937;
    --btn-hover:#374151;
    --gold:#fbbf24;
    --shadow:0 10px 30px rgba(0,0,0,0.4);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:linear-gradient(180deg,#0b0f17,#0a1222); color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; height:100%}
  #app{min-height:100vh; display:flex; flex-direction:column}
  header{position:sticky; top:0; z-index:5; background:rgba(10,16,30,.8); backdrop-filter: blur(8px); box-shadow: var(--shadow);}
  .bar{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; gap:10px}
  .title{font-weight:800; letter-spacing:.5px}
  .sub{font-size:12px; color:var(--muted)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .chip{padding:6px 10px; border-radius:999px; background:var(--panel); border:1px solid #1f2937; font-size:12px}
  .chip .num{color:var(--gold); font-weight:700}
  .btn{appearance:none; border:0; background:var(--btn); color:var(--text); border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; transition:.15s transform,.15s background; box-shadow: var(--shadow)}
  .btn:hover{background:var(--btn-hover); transform:translateY(-1px)}
  .btn[disabled]{opacity:.5; cursor:not-allowed; transform:none}
  .primary{background:linear-gradient(135deg,#00d0ff,#6e7bff)}
  .danger{background:linear-gradient(135deg,#ff4d4d,#ff7a59)}
  .success{background:linear-gradient(135deg,#22c55e,#16a34a)}
  main{flex:1; padding:16px; display:grid; place-items:stretch; gap:16px}
  .screen{display:none}
  .screen.active{display:block; animation:fade .25s ease}
  @keyframes fade{from{opacity:0; transform:translateY(3px)} to{opacity:1; transform:none}}
  .card{background:linear-gradient(180deg,var(--panel), var(--panel-2)); border:1px solid #1f2937; border-radius:var(--radius); padding:16px; box-shadow: var(--shadow)}
  .grid{display:grid; gap:12px}
  .two{grid-template-columns:1fr 1fr}
  .three{grid-template-columns:repeat(3,1fr)}
  .four{grid-template-columns:repeat(4,1fr)}
  @media (max-width:900px){ .two,.three,.four{grid-template-columns:1fr}}
  .center{display:grid; place-items:center}
  .title-xl{font-size:28px; font-weight:900}
  .title-lg{font-size:20px; font-weight:800}
  .muted{color:var(--muted)}
  .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .scroll{overflow:auto; max-height:55vh; padding-right:6px}
  .pill{padding:4px 8px; border:1px solid #263043; border-radius:999px; font-size:12px}
  .badge{padding:4px 8px; border-radius:8px; border:1px solid #27344a; font-size:12px; cursor:pointer}
  .item{background:#0c1324; border:1px solid #1f2a44; border-radius:12px; padding:10px; display:flex; gap:10px; align-items:center}
  .portrait{width:56px; height:56px; border-radius:10px; background:#0a1022; border:1px solid #1e293b; object-fit:cover}
  .rar{font-weight:900; letter-spacing:1px}
  .rar-gradient{background-clip:text; -webkit-background-clip:text; color:transparent}
  .table{width:100%; border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid #1f2937; padding:6px 8px; text-align:left; font-size:13px}
  .input, select, textarea{width:100%; background:#0b1224; color:var(--text); border:1px solid #1f2937; border-radius:10px; padding:10px; outline:none}
  .search{display:flex; gap:10px; align-items:center}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:12px; padding:2px 6px; border:1px solid #22314a; border-radius:6px; color:#a3b2cc}
  .toast{position:fixed; right:10px; bottom:10px; background:#0b1224; border:1px solid #1f2937; padding:10px 14px; border-radius:10px; box-shadow: var(--shadow); z-index:20; display:none}
  dialog{border:0; padding:0; background:transparent}
  .modal{width:min(900px,95vw); background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow: var(--shadow)}
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:12px}
  .progress{height:10px; background:#0c1324; border:1px solid #1f2937; border-radius:999px; overflow:hidden}
  .progress>span{display:block; height:100%; background:linear-gradient(90deg,#22c55e,#3b82f6)}
  .divider{height:1px; background:#1f2937; margin:6px 0}
  .note{font-size:12px; color:#9aa7c4}
  .nowrap{white-space:nowrap}
  .footer{font-size:12px; color:#93a0bd; opacity:.8; padding:10px 16px; text-align:center}
  .tag-cloud{display:flex; gap:6px; flex-wrap:wrap}
  .hidden{display:none !important}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="bar">
      <div>
        <div class="title">Gacha Realms <span class="sub">â€” Character Gacha RPG (Advanced)</span></div>
        <div class="sub">Fully editable systems â€¢ Local-first saves â€¢ Import/Export JSON</div>
      </div>
      <div class="row">
        <span class="chip">Coins: <span id="coins" class="num">0</span></span>
        <span class="chip">Gems: <span id="gems" class="num">0</span></span>
        <button class="btn" id="btnToMenu">Menu</button>
        <button class="btn primary" id="btnToSummon">Summon</button>
        <button class="btn" id="btnToInventory">Inventory</button>
        <button class="btn" id="btnToSettings">Settings</button>
      </div>
    </div>
  </header>

  <main>
    <!-- MAIN MENU -->
    <section id="screen_main_menu" class="screen active">
      <div class="card center">
        <div class="grid two">
          <div class="center">
            <div>
              <div class="title-xl">Welcome to <span style="color:var(--accent)">Gacha Realms</span></div>
              <p class="muted">Tap <b>Summon</b> to roll characters, then manage, level up, and ascend them. Everything is fully editable in Settings.</p>
              <div class="flex">
                <button class="btn primary" id="startTenPull">ðŸŽ² Ten Pull (x10) â€” 1500 Gems</button>
                <button class="btn" id="startSinglePull">ðŸŽ¯ Single â€” 160 Gems</button>
                <button class="btn success" id="grantStarter">ðŸ’° Starter Pack</button>
              </div>
              <p class="note">Pity enabled: guaranteed SSS at 100 pulls without SSS+.</p>
            </div>
          </div>
          <div class="grid">
            <div class="card">
              <div class="title-lg">Recent Pulls</div>
              <div id="recentPulls" class="scroll"></div>
            </div>
            <div class="card">
              <div class="title-lg">Daily Missions</div>
              <ul class="muted">
                <li>Do a single pull (+80 Coins)</li>
                <li>Do a ten pull (+900 Coins)</li>
                <li>Level up any character (+50 Coins)</li>
              </ul>
              <div class="flex">
                <button class="btn success" id="btnDailyClaim">Claim All</button>
                <button class="btn" id="btnBackupNow">Backup Save</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SUMMON -->
    <section id="screen_summon_screen" class="screen">
      <div class="grid two">
        <div class="card">
          <div class="title-lg">Summon Pool</div>
          <p class="muted">Tap to roll. Uses Gems. Pity: <span id="pityCount">0</span>/100</p>
          <div class="flex">
            <button class="btn primary" id="btnSingle">Single (160)</button>
            <button class="btn primary" id="btnTen">Ten Pull (1500)</button>
            <button class="btn" id="btnRates">Show Rates</button>
          </div>
        </div>
        <div class="card">
          <div class="title-lg">Results</div>
          <div id="summonResults" class="grid three"></div>
        </div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="screen_character_inventory" class="screen">
      <div class="card">
        <div class="topbar">
          <div class="title-lg">Characters</div>
          <div class="search" style="flex:1">
            <input id="searchInput" class="input" placeholder="Search name, class, origin, tagsâ€¦ (try: Fire, Elf, Skyrend)">
            <span class="kbd">/</span>
            <select id="rarityFilter">
              <option value="">All Rarities</option>
            </select>
            <button class="btn" id="btnClearFilters">Clear</button>
            <button class="btn" id="btnExport">Export</button>
            <input type="file" id="importFile" class="hidden" accept="application/json" />
            <button class="btn" id="btnImport">Import</button>
          </div>
        </div>
        <div id="inventoryList" class="grid"></div>
      </div>
    </section>

    <!-- LEVEL / ASCEND handled via modal -->

    <!-- SETTINGS -->
    <section id="screen_settings" class="screen">
      <div class="grid two">
        <div class="card">
          <div class="title-lg">Economy</div>
          <div class="grid two">
            <label>Coins <input id="setCoins" class="input" type="number" min="0"></label>
            <label>Gems <input id="setGems" class="input" type="number" min="0"></label>
          </div>
          <div class="grid two">
            <label>Coinsâ†’Gems rate <input id="rateCoinsToGems" class="input" type="number" min="1"></label>
            <button class="btn" id="btnConvertCoins">Convert 1000 Coins â†’ 1 Gem</button>
          </div>
          <div class="divider"></div>
          <div class="title-lg">Rarities & Drop Rates</div>
          <div id="rarityEditor" class="grid"></div>
          <div class="flex">
            <button class="btn success" id="btnSaveRates">Save Rates</button>
            <button class="btn" id="btnResetRates">Reset Defaults</button>
          </div>
        </div>
        <div class="card">
          <div class="title-lg">Customization & Save</div>
          <div class="grid">
            <label>UI Theme
              <select id="uiTheme">
                <option value="dark">Dark (default)</option>
                <option value="midnight">Midnight Blue</option>
                <option value="amethyst">Amethyst</option>
                <option value="emerald">Emerald</option>
              </select>
            </label>
            <div class="flex">
              <button class="btn" id="btnSaveSettings">Save Settings</button>
              <button class="btn danger" id="btnWipe">Factory Reset</button>
            </div>
            <div>
              <div class="title-lg">Backups</div>
              <div id="backupList" class="scroll" style="max-height:200px"></div>
              <div class="flex">
                <button class="btn" id="btnCreateBackup">Create Backup</button>
                <button class="btn danger" id="btnClearBackups">Clear Backups</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="footer">Gacha Realms â€” Local demo. All systems are editable. No external libraries.</div>
</div>

<!-- Character Modal -->
<dialog id="charDialog">
  <div class="modal">
    <div class="topbar">
      <div class="flex">
        <img id="charPortrait" class="portrait" alt="portrait"/>
        <div>
          <div class="title-lg"><span id="charName"></span> <span id="charRarity" class="rar rar-gradient"></span></div>
          <div class="muted"><span id="charClass"></span> â€¢ <span id="charOrigin"></span></div>
          <div id="charTags" class="tag-cloud"></div>
        </div>
      </div>
      <button class="btn" id="btnCloseDialog">Close</button>
    </div>
    <div class="grid two">
      <div class="card">
        <div class="title-lg">Stats</div>
        <table class="table" id="statsTable"></table>
        <div class="divider"></div>
        <div class="grid two">
          <div>
            <div class="muted">Level</div>
            <div class="progress"><span id="levelBar" style="width:0%"></span></div>
            <div><span id="levelText"></span></div>
          </div>
          <div>
            <div class="muted">Ascension</div>
            <div class="progress"><span id="ascBar" style="width:0%"></span></div>
            <div><span id="ascText"></span></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="title-lg">Actions</div>
        <div class="grid two">
          <button class="btn success" id="btnLevelUp">Level Up (50 Coins)</button>
          <button class="btn" id="btnAscend">Ascend (cost scales)</button>
          <button class="btn" id="btnAddTag">Add Tag</button>
          <button class="btn danger" id="btnDeleteChar">Delete</button>
        </div>
        <div class="divider"></div>
        <div class="title-lg">Skills</div>
        <div id="skillList" class="grid"></div>
      </div>
    </div>
  </div>
</dialog>

<div class="toast" id="toast"></div>

<script>
/* =========================================================
   GACHA REALMS â€” ADVANCED, SINGLE-FILE DEMO
   Systems implemented:
   - Gacha with 13 rarities, pity, single & ten-pull
   - Currencies (Coins+Gems) + conversion
   - Character entity with D&D stats, class, origin, tags
   - Inventory with search, rarity filter, multi-tag filter, autocomplete
   - Popup character modal (level up, ascend, add tags, delete)
   - Editable rarity table + colors + drop rates
   - Local JSON "DB" with export/import; backups; daily backup
   - Theme switching
   ========================================================= */

const DEFAULT_CONFIG = {
  game: {
    title: "Gacha Realms",
    genre: "Character Gacha RPG",
    platform: "Mobile",
    editable: true,
  },
  economy:{
    currencies:[
      { name:"Coins", type:"soft", use:"leveling, upgrades, ascension materials", editable:true },
      { name:"Gems", type:"premium", use:"summoning and premium shop", editable:true }
    ],
    conversion:{ coins_to_gems: 1000 }
  },
  systems:{
    gacha:{
      rarities:[
        { rank:"F",  color:["#000000","#808080"], drop_rate:0.40 },
        { rank:"E",  color:["#556B2F","#228B22"], drop_rate:0.25 },
        { rank:"D",  color:["#4169E1","#0000CD"], drop_rate:0.15 },
        { rank:"C",  color:["#800080","#6A0DAD"], drop_rate:0.08 },
        { rank:"B",  color:["#FFD700","#FFB300"], drop_rate:0.05 },
        { rank:"A",  color:["#DC143C","#FF4500"], drop_rate:0.03 },
        { rank:"S",  color:["#FFFFFF","#C0C0C0"], drop_rate:0.02 },
        { rank:"SS", color:["#008080","#00FFFF"], drop_rate:0.01 },
        { rank:"SSS",color:["#4B0082","#FF00FF"], drop_rate:0.007 },
        { rank:"EX", color:["#0000FF","#E6E6FA"], drop_rate:0.004 },
        { rank:"Î©",  color:["#000000","#00FFFF"], drop_rate:0.002 },
        { rank:"XÎ©", color:["#FF0000","#00FFFF"], drop_rate:0.001 },
        { rank:"âˆž",  color:["#FF00FF","#FFFFFF"], drop_rate:0.0005 }
      ],
      summon_modes:["single","ten_pull"],
      pity_system:{ enabled:true, counter_max:100, guaranteed_rarity:"SSS" }
    },
    progression:{
      level_cap:100,
      ascension_tiers:5,
      stat_scaling:"based on rarity multiplier",
      xp_growth:"exponential",
      editable:true
    },
    tags_system:{
      tag_assign:true, multi_tag_support:true, tag_search:true,
      examples:["Fire","Elf","Undead","Royal","GuildA"]
    },
    world_origin:{
      enabled:true, editable:true,
      examples:["Skyrend","Eterna","Voidreach","Aetherfall"]
    }
  },
  database:{
    type:"SQLite", // emulated by localStorage JSON in this demo
    tables:["characters","inventory","currencies","ascension_data","worlds","tags"],
    functions:{
      create:true, read:true, update:true, delete:true, export:true, import:true,
      search:{ enabled:true, search_fields:["name","class","world_origin","tags"], multi_tag_filter:true, autocomplete:true }
    }
  },
  ui:{
    screens:["main_menu","summon_screen","character_inventory","popup_character_info","level_up_screen","ascension_screen","settings"],
  },
  customization:{
    editable_values:["drop_rates","rarity_colors","stats_growth","currency_rates","ui_theme","background_images"],
    auto_balance_toggle:true
  },
  save_system:{ local_save:true, cloud_sync:true, daily_backup:true }
};

// Local DB (JSON) ------------------------------------------------------------
const DB_KEY = "gacha_realms_db_v1";
const BACKUP_KEY = "gacha_realms_backups";
const TODAY = new Date().toISOString().slice(0,10);

function loadDB(){
  const raw = localStorage.getItem(DB_KEY);
  if(!raw){
    const seed = {
      config: structuredClone(DEFAULT_CONFIG),
      currencies:{ coins: 5000, gems: 1800, pity: 0 },
      characters:[], // inventory
      catalog: seedCatalog(),
      backups:{},
      theme:"dark"
    };
    localStorage.setItem(DB_KEY, JSON.stringify(seed));
    return seed;
  }
  try{ return JSON.parse(raw); } catch(e){
    console.warn("Corrupt save, resetting.", e);
    localStorage.removeItem(DB_KEY);
    return loadDB();
  }
}
function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); uiUpdate(); }
function dailyBackup(db){
  if(!db.backups) db.backups={};
  if(!db.backups[TODAY]){
    db.backups[TODAY] = JSON.stringify(db);
    localStorage.setItem(BACKUP_KEY, JSON.stringify(db.backups));
  }
}
function seedCatalog(){
  // Simple procedural generator for placeholder images and baseline stats
  const classes = ["Warrior","Mage","Rogue","Cleric","Ranger","Monk"];
  const origins = DEFAULT_CONFIG.systems.world_origin.examples;
  const tags = DEFAULT_CONFIG.systems.tags_system.examples;
  const list = [];
  for(let i=0;i<24;i++){
    const name = randomName();
    const cls = pick(classes);
    const origin = pick(origins);
    const portrait = `https://picsum.photos/seed/gr${i}/128/128`; // demo placeholder
    const base = dndStats();
    list.push({ name, class:cls, world_origin:origin, tags:[pick(tags)], image_url:portrait, base });
  }
  return list;
}
function dndStats(){
  const roll=()=> Math.max(3, Math.floor(8+Math.random()*10)); // 8-18
  return { STR:roll(), DEX:roll(), CON:roll(), INT:roll(), WIS:roll(), CHA:roll() };
}
function rarityMultiplier(rank){
  const order = ["F","E","D","C","B","A","S","SS","SSS","EX","Î©","XÎ©","âˆž"];
  const idx = order.indexOf(rank);
  return 0.6 + idx*0.25; // scalable
}

// Helpers --------------------------------------------------------------------
const $ = sel => document.querySelector(sel);
function el(tag, attrs={}, children=[]){
  const n = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k==="class") n.className=v;
    else if(k==="style") n.setAttribute("style", v);
    else if(k.startsWith("on")) n.addEventListener(k.slice(2), v);
    else n.setAttribute(k,v);
  }
  for(const c of children){
    if(typeof c==="string") n.appendChild(document.createTextNode(c)); else n.appendChild(c);
  }
  return n;
}
function toast(msg){
  const t=$("#toast"); t.textContent=msg; t.style.display="block";
  setTimeout(()=> t.style.display="none", 1800);
}
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)) }
function gradientText(from,to){ return `background: linear-gradient(90deg, ${from}, ${to}); -webkit-background-clip:text; background-clip:text; color:transparent;` }

// State ----------------------------------------------------------------------
let DB = loadDB();
if(DB && DB.config?.save_system?.daily_backup) dailyBackup(DB);
uiUpdate();
renderAll();

// UI Navigation --------------------------------------------------------------
function show(screen){
  document.querySelectorAll(".screen").forEach(s=> s.classList.remove("active"));
  $("#screen_"+screen).classList.add("active");
}
$("#btnToMenu").onclick = ()=> show("main_menu");
$("#btnToSummon").onclick = ()=> show("summon_screen");
$("#btnToInventory").onclick = ()=> { show("character_inventory"); renderInventory(); };
$("#btnToSettings").onclick = ()=> { show("settings"); renderSettings(); };

// Main menu quick actions
$("#grantStarter").onclick = ()=>{
  DB.currencies.coins += 5000;
  DB.currencies.gems += 2000;
  saveDB(DB); toast("Starter Pack granted!");
};
$("#startTenPull").onclick = ()=> doTenPull();
$("#startSinglePull").onclick = ()=> doSinglePull();
$("#btnDailyClaim").onclick = ()=> { DB.currencies.coins += 1030; saveDB(DB); toast("Daily missions claimed! +1030 Coins"); };
$("#btnBackupNow").onclick = ()=> { createBackup(); renderBackups(); toast("Backup created."); };

// Summon screen --------------------------------------------------------------
$("#btnSingle").onclick = ()=> doSinglePull();
$("#btnTen").onclick = ()=> doTenPull();
$("#btnRates").onclick = ()=> showRatesDialog();

function doSinglePull(){
  if(DB.currencies.gems < 160){ toast("Not enough Gems."); return; }
  DB.currencies.gems -= 160;
  const res = rollOne();
  addToInventory(res);
  DB.currencies.pity = res.isHigh ? 0 : DB.currencies.pity + 1;
  logPull(res);
  saveDB(DB);
  renderSummonResult([res]);
}
function doTenPull(){
  if(DB.currencies.gems < 1500){ toast("Not enough Gems."); return; }
  DB.currencies.gems -= 1500;
  const results=[];
  for(let i=0;i<10;i++){
    const res = rollOne();
    addToInventory(res);
    DB.currencies.pity = res.isHigh ? 0 : DB.currencies.pity + 1;
    results.push(res);
  }
  saveDB(DB);
  renderSummonResult(results);
}

function rollOne(){
  const pityOn = DB.config.systems.gacha.pity_system.enabled;
  const pityMax = DB.config.systems.gacha.pity_system.counter_max;
  const pityGuarantee = DB.config.systems.gacha.pity_system.guaranteed_rarity;
  const pity = DB.currencies.pity ?? 0;

  // Build weighted table
  const table = DB.config.systems.gacha.rarities.map(r=>({rank:r.rank, w:r.drop_rate}));
  // Apply pity override
  let forced=null;
  if(pityOn && pity+1 >= pityMax){
    forced = pityGuarantee;
  }

  let rarity = forced || weightedPick(table);
  const rarCfg = DB.config.systems.gacha.rarities.find(r=> r.rank===rarity) || DB.config.systems.gacha.rarities[0];
  const base = pick(DB.catalog).base;
  const name = randomName();
  const cls = pick(["Warrior","Mage","Rogue","Cleric","Ranger","Monk"]);
  const origin = pick(DB.config.systems.world_origin.examples);
  const tags = [pick(DB.config.systems.tags_system.examples)];
  const image_url = `https://picsum.photos/seed/gr${Math.floor(Math.random()*100000)}/256/256`;
  const stats = scaleStats(base, rarity);
  const isHigh = ["SSS","EX","Î©","XÎ©","âˆž"].includes(rarity);
  return { name, rarity, class:cls, world_origin:origin, tags, image_url, stats, level:1, ascension:0, isHigh };
}
function weightedPick(table){
  let total = table.reduce((a,b)=> a+b.w, 0);
  let r = Math.random()*total;
  for(const t of table){
    if(r < t.w) return t.rank;
    r -= t.w;
  }
  return table[0].rank;
}
function scaleStats(base, rarity){
  const mult = rarityMultiplier(rarity);
  const s={};
  for(const k of ["STR","DEX","CON","INT","WIS","CHA"]){
    s[k] = Math.round(base[k]*mult);
  }
  return s;
}
function addToInventory(character){
  const id = crypto.randomUUID();
  DB.characters.push({ id, ...character, skills:{active:[], passive:[]}});
}
function logPull(res){
  const ctn = $("#recentPulls");
  const rar = rarityColor(res.rarity);
  const row = el("div",{class:"item"},[
    el("img",{class:"portrait", src:res.image_url, alt:"portrait"}),
    el("div",{},[
      el("div",{},[res.name," â€¢ ", el("span",{class:"rar rar-gradient", style:gradientText(rar[0],rar[1])},[res.rarity])]),
      el("div",{class:"muted"},[res.class," â€¢ ",res.world_origin," â€¢ ", res.tags.join(", ")]),
    ])
  ]);
  ctn.prepend(row);
}
function renderSummonResult(results){
  $("#pityCount").textContent = DB.currencies.pity ?? 0;
  const grid = $("#summonResults"); grid.innerHTML="";
  for(const r of results){
    const rar = rarityColor(r.rarity);
    const card = el("div",{class:"card center"},[
      el("img",{class:"portrait", src:r.image_url}),
      el("div",{class:"rar rar-gradient", style:gradientText(rar[0],rar[1])},[r.rarity]),
      el("div",{class:"muted"},[r.name]),
    ]);
    grid.appendChild(card);
  }
}

// Inventory ------------------------------------------------------------------
function renderInventory(){
  const list = $("#inventoryList"); list.innerHTML="";
  const rarSel = $("#rarityFilter"); rarSel.innerHTML='<option value="">All Rarities</option>';
  DB.config.systems.gacha.rarities.forEach(r=>{
    const opt = el("option",{value:r.rank},[r.rank]);
    rarSel.appendChild(opt);
  });

  const q = $("#searchInput").value.trim().toLowerCase();
  const rarFilter = $("#rarityFilter").value;
  const items = DB.characters.filter(ch => {
    const matchesRar = !rarFilter || ch.rarity===rarFilter;
    const hay = [ch.name, ch.class, ch.world_origin, ...(ch.tags||[])].join(" ").toLowerCase();
    const matchesQ = !q || q.split(/\s+/).every(tok=> hay.includes(tok));
    return matchesRar && matchesQ;
  });

  if(items.length===0){
    list.appendChild(el("div",{class:"muted"},["No characters yet. Try summoning!"]));
    return;
  }

  for(const ch of items){
    const rar = rarityColor(ch.rarity);
    const row = el("div",{class:"item", onclick:()=> openCharacter(ch.id)},[
      el("img",{class:"portrait", src:ch.image_url, alt:ch.name}),
      el("div",{style:"flex:1"},[
        el("div",{},[ch.name," â€¢ ", el("span",{class:"rar rar-gradient", style:gradientText(rar[0],rar[1])},[ch.rarity])]),
        el("div",{class:"muted"},[ch.class," â€¢ ", ch.world_origin]),
        el("div",{class:"tag-cloud"}, ch.tags?.map(t=> el("span",{class:"badge"},[t])) || [])
      ]),
      el("div",{class:"pill nowrap"},[`Lv ${ch.level} / ${DB.config.systems.progression.level_cap}`]),
    ]);
    list.appendChild(row);
  }
}
$("#searchInput").addEventListener("input", ()=> renderInventory());
$("#rarityFilter").addEventListener("change", ()=> renderInventory());
$("#btnClearFilters").onclick = ()=> { $("#searchInput").value=""; $("#rarityFilter").value=""; renderInventory(); };

// Export / Import
$("#btnExport").onclick = ()=>{
  const data = new Blob([JSON.stringify(DB)],{type:"application/json"});
  const a = el("a",{href:URL.createObjectURL(data), download:"gacha_realms_save.json"});
  document.body.appendChild(a); a.click(); a.remove();
};
$("#btnImport").onclick = ()=> $("#importFile").click();
$("#importFile").addEventListener("change", (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const newDB = JSON.parse(reader.result);
      DB = newDB; saveDB(DB); toast("Import successful."); renderAll();
    }catch(err){ toast("Import failed: invalid JSON."); }
  };
  reader.readAsText(file);
});

// Character Modal ------------------------------------------------------------
const dlg = $("#charDialog");
$("#btnCloseDialog").onclick = ()=> dlg.close();

function openCharacter(id){
  const ch = DB.characters.find(c=> c.id===id); if(!ch) return;
  dlg.showModal();
  $("#charPortrait").src = ch.image_url;
  $("#charName").textContent = ch.name;
  const rar = rarityColor(ch.rarity);
  $("#charRarity").setAttribute("style", gradientText(rar[0],rar[1]));
  $("#charRarity").textContent = ch.rarity;
  $("#charClass").textContent = ch.class;
  $("#charOrigin").textContent = ch.world_origin;
  const tags = $("#charTags"); tags.innerHTML="";
  (ch.tags||[]).forEach(t=> tags.appendChild(el("span",{class:"badge", onclick:()=> { $("#searchInput").value=t; dlg.close(); show('character_inventory'); renderInventory(); }},[t])));
  // stats
  const tbl=$("#statsTable"); tbl.innerHTML="";
  tbl.appendChild(el("tr",{},[el("th",{},["Stat"]), el("th",{},["Value"])]));
  for(const k of ["STR","DEX","CON","INT","WIS","CHA"]){
    tbl.appendChild(el("tr",{},[el("td",{},[k]), el("td",{},[String(ch.stats[k])])]));
  }
  // level/asc
  const cap = DB.config.systems.progression.level_cap;
  const ascTiers = DB.config.systems.progression.ascension_tiers;
  $("#levelBar").style.width = `${(ch.level-1)/(cap-1)*100}%`;
  $("#ascBar").style.width = `${ch.ascension/ascTiers*100}%`;
  $("#levelText").textContent = `Lv ${ch.level}/${cap}`;
  $("#ascText").textContent = `Tier ${ch.ascension}/${ascTiers}`;
  // skills
  const skills = $("#skillList"); skills.innerHTML="";
  const empty = (ch.skills?.active?.length||0)+(ch.skills?.passive?.length||0)===0;
  if(empty) skills.appendChild(el("div",{class:"muted"},["No skills yet."]));
  // actions
  $("#btnLevelUp").onclick = ()=> { levelUp(ch.id); openCharacter(ch.id); };
  $("#btnAscend").onclick = ()=> { ascend(ch.id); openCharacter(ch.id); };
  $("#btnAddTag").onclick = ()=> {
    const tag = prompt("Enter a tag (e.g., Fire, Elf, GuildA)"); if(!tag) return;
    ch.tags = Array.from(new Set([...(ch.tags||[]), tag]));
    saveDB(DB); openCharacter(ch.id);
  };
  $("#btnDeleteChar").onclick = ()=> {
    if(confirm("Delete this character?")){
      DB.characters = DB.characters.filter(c=> c.id!==id);
      saveDB(DB); dlg.close(); renderInventory();
    }
  };
}
function levelUp(id){
  const ch = DB.characters.find(c=> c.id===id); if(!ch) return;
  if(DB.currencies.coins < 50){ toast("Not enough Coins."); return; }
  if(ch.level >= DB.config.systems.progression.level_cap){ toast("Reached level cap."); return; }
  DB.currencies.coins -= 50;
  ch.level += 1;
  // minor stat growth
  for(const k of ["STR","DEX","CON","INT","WIS","CHA"]) ch.stats[k]+=1;
  saveDB(DB); toast("Level up!");
}
function ascend(id){
  const ch = DB.characters.find(c=> c.id===id); if(!ch) return;
  const maxTier = DB.config.systems.progression.ascension_tiers;
  if(ch.ascension >= maxTier){ toast("Max ascension reached."); return; }
  const cost = 200 + ch.ascension*200;
  if(DB.currencies.coins < cost){ toast("Need "+cost+" Coins."); return; }
  DB.currencies.coins -= cost;
  ch.ascension += 1;
  // bigger stat growth
  for(const k of ["STR","DEX","CON","INT","WIS","CHA"]) ch.stats[k]+=3;
  saveDB(DB); toast("Ascended!");
}

// Settings -------------------------------------------------------------------
function renderSettings(){
  $("#setCoins").value = DB.currencies.coins;
  $("#setGems").value = DB.currencies.gems;
  $("#rateCoinsToGems").value = DB.config.economy.conversion.coins_to_gems;
  renderRarityEditor();
  renderBackups();
  $("#uiTheme").value = DB.theme || "dark";
}
$("#btnConvertCoins").onclick = ()=>{
  const rate = DB.config.economy.conversion.coins_to_gems || 1000;
  if(DB.currencies.coins < rate){ toast("Not enough Coins."); return; }
  DB.currencies.coins -= rate; DB.currencies.gems += 1; saveDB(DB);
};
$("#btnSaveSettings").onclick = ()=>{
  DB.currencies.coins = Number($("#setCoins").value);
  DB.currencies.gems = Number($("#setGems").value);
  DB.config.economy.conversion.coins_to_gems = Number($("#rateCoinsToGems").value);
  DB.theme = $("#uiTheme").value;
  applyTheme(); saveDB(DB); toast("Settings saved.");
};
$("#btnWipe").onclick = ()=>{
  if(confirm("Factory reset? This clears all data.")){
    localStorage.removeItem(DB_KEY);
    localStorage.removeItem(BACKUP_KEY);
    DB = loadDB(); renderAll(); toast("Reset complete.");
  }
};

function renderRarityEditor(){
  const host=$("#rarityEditor"); host.innerHTML="";
  DB.config.systems.gacha.rarities.forEach((r,i)=>{
    const row = el("div",{class:"item"},[
      el("div",{class:"rar rar-gradient", style:gradientText(r.color[0], r.color[1])},[r.rank]),
      el("label",{style:"flex:1"},["Drop Rate", el("input",{type:"number", class:"input", min:"0", step:"0.0001", value:r.drop_rate, oninput:e=> r.drop_rate = Number(e.target.value)})]),
      el("label",{},["Color 1", el("input",{type:"color", value: toColor(r.color[0]), oninput:e=> r.color[0]=e.target.value})]),
      el("label",{},["Color 2", el("input",{type:"color", value: toColor(r.color[1]), oninput:e=> r.color[1]=e.target.value})]),
    ]);
    host.appendChild(row);
  });
}
function toColor(v){
  // support 3/6/8 digits; ensure valid hex
  return /^#/.test(v) ? v : "#ffffff";
}
$("#btnSaveRates").onclick = ()=> { saveDB(DB); toast("Rates & colors saved."); };
$("#btnResetRates").onclick = ()=> { DB.config.systems.gacha.rarities = structuredClone(DEFAULT_CONFIG.systems.gacha.rarities); saveDB(DB); renderRarityEditor(); toast("Rarities reset."); };

// Backups
function createBackup(){
  const backups = JSON.parse(localStorage.getItem(BACKUP_KEY) || "{}");
  const stamp = new Date().toISOString().replace(/[:.]/g,"-");
  backups[stamp] = JSON.stringify(DB);
  localStorage.setItem(BACKUP_KEY, JSON.stringify(backups));
  DB.backups = backups;
}
function renderBackups(){
  const host = $("#backupList"); host.innerHTML="";
  const backups = JSON.parse(localStorage.getItem(BACKUP_KEY) || "{}");
  const keys = Object.keys(backups).sort().reverse();
  if(keys.length===0){ host.appendChild(el("div",{class:"muted"},["No backups yet."])); return; }
  keys.forEach(k=>{
    const row = el("div",{class:"item"},[
      el("div",{style:"flex:1"},[k]),
      el("button",{class:"btn", onclick:()=>{
        const j = JSON.parse(backups[k]);
        DB = j; saveDB(DB); renderAll(); toast("Backup restored.");
      }},["Restore"]),
      el("button",{class:"btn", onclick:()=>{
        const a = el("a",{href:URL.createObjectURL(new Blob([backups[k]],{type:"application/json"})), download:`backup_${k}.json`}); document.body.appendChild(a); a.click(); a.remove();
      }},["Download"]),
    ]);
    host.appendChild(row);
  });
}
$("#btnCreateBackup").onclick = ()=> { createBackup(); renderBackups(); toast("Backup created."); };
$("#btnClearBackups").onclick = ()=>{
  if(confirm("Delete all backups?")){ localStorage.removeItem(BACKUP_KEY); DB.backups={}; renderBackups(); }
};

// Rates dialog ---------------------------------------------------------------
function showRatesDialog(){
  const dlg = document.createElement("dialog");
  dlg.innerHTML = `<div class="modal"><div class="topbar"><div class="title-lg">Drop Rates</div><button class="btn" id="x">Close</button></div>
  <table class="table">${DB.config.systems.gacha.rarities.map(r=>`<tr><td><b>${r.rank}</b></td><td>${(r.drop_rate*100).toFixed(3)}%</td></tr>`).join("")}</table>
  <p class="note">Total ${(DB.config.systems.gacha.rarities.reduce((a,b)=>a+b.drop_rate,0)*100).toFixed(3)}%</p></div>`;
  document.body.appendChild(dlg);
  dlg.showModal();
  dlg.querySelector("#x").onclick = ()=> { dlg.close(); dlg.remove(); };
}

// Misc -----------------------------------------------------------------------
function rarityColor(rank){
  const r = DB.config.systems.gacha.rarities.find(rr => rr.rank===rank);
  return r ? r.color : ["#888888","#cccccc"];
}
function uiUpdate(){
  $("#coins").textContent = DB.currencies.coins;
  $("#gems").textContent = DB.currencies.gems;
  $("#pityCount").textContent = DB.currencies.pity ?? 0;
  applyTheme();
}
function applyTheme(){
  const root = document.documentElement;
  const t = DB.theme || "dark";
  if(t==="midnight"){
    root.style.setProperty("--bg","#081019");
    root.style.setProperty("--panel","#0d1a2a");
    root.style.setProperty("--panel-2","#0b1624");
    root.style.setProperty("--accent","#60a5fa");
  }else if(t==="amethyst"){
    root.style.setProperty("--panel","#19142a");
    root.style.setProperty("--panel-2","#120f22");
    root.style.setProperty("--accent","#c084fc");
  }else if(t==="emerald"){
    root.style.setProperty("--panel","#10241a");
    root.style.setProperty("--panel-2","#0c1d15");
    root.style.setProperty("--accent","#34d399");
  }else{
    // default dark
    root.style.removeProperty("--panel");
    root.style.removeProperty("--panel-2");
    root.style.removeProperty("--accent");
  }
}
function renderAll(){
  renderInventory(); renderSettings(); uiUpdate();
}

// Utilities ------------------------------------------------------------------
function randomName(){
  const A=["Ara","Bel","Cael","Dra","Ela","Faer","Gor","Hym","Ira","Jas","Kael","Lun","Mor","Nym","Or","Pyr","Quel","Ryn","Syl","Tor","Um","Vyr","Wyn","Xan","Yor","Zel"];
  const B=["drel","mira","thas","vyn","lith","gorn","jara","syl","vore","ryn","nix","thil","ver","lune","most","skai","dera","zeth"];
  return pick(A)+pick(B);
}

// Keyboard search focus
window.addEventListener("keydown", (e)=>{
  if(e.key==="/"){ e.preventDefault(); $("#searchInput").focus(); }
});

</script>
</body>
</html>
