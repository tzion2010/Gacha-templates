<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ultra-Editable Gacha (13 Rarities + DnD Stats)</title>
<style>
  :root{
    --accent: #4b6bfb;
    --bg: #0f1220;
    --card: #171a2b;
    --text: #e7ebff;
    --muted: #96a0c8;
    --bad: #ff6961;
    --good: #66e2a4;
    --warning: #ffd166;
  }
  *{ box-sizing: border-box; }
  html, body{
    margin:0; padding:0; background: var(--bg); color: var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }

  header{
    position: sticky; top:0; z-index: 3;
    background: linear-gradient(180deg, rgba(15,18,32,0.96), rgba(15,18,32,0.85));
    backdrop-filter: blur(6px);
    border-bottom: 1px solid #22253a;
  }

  .wrap{ max-width: 1200px; margin: 0 auto; padding: 14px 16px; }
  h1{ font-size: clamp(20px, 3vw, 28px); margin: 6px 0 8px; }
  h2{ font-size: 20px; margin: 18px 0 10px; }
  h3{ font-size: 16px; margin: 14px 0 8px; color: var(--muted); font-weight:600; }
  p{ color: var(--muted); }

  .tabs{ display:flex; gap:8px; flex-wrap: wrap; }
  .tab-btn{
    border:1px solid #2a2e49; background:#14182a; color:var(--text);
    padding:8px 12px; border-radius: 10px; cursor:pointer;
  }
  .tab-btn.active{ outline:2px solid var(--accent); }

  .grid{
    display:grid; gap:12px;
  }
  @media (min-width: 900px){
    .grid.cols-2{ grid-template-columns: 1fr 1fr; }
    .grid.cols-3{ grid-template-columns: 1fr 1fr 1fr; }
  }

  .panel{
    background: var(--card);
    border: 1px solid #232744;
    border-radius: 16px;
    padding: 14px;
  }

  input, select, textarea, button{
    background: #0e1120; color: var(--text); border:1px solid #2c3255;
    padding:8px 10px; border-radius: 10px; font-size:14px;
  }
  label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .row > *{ flex: 1 1 auto; }

  .btn{
    background: linear-gradient(135deg, #4455ff, #7a5cff);
    border:none; color:white; padding:9px 12px; border-radius:10px; cursor:pointer;
    font-weight:600; letter-spacing:.2px;
  }
  .btn.soft{ background:#151939; border:1px solid #2a2f53; }
  .btn.warn{ background: linear-gradient(135deg, #ffd166, #ff9d66); color:#171717; }
  .btn.danger{ background: linear-gradient(135deg, #ff6b6b, #f06595); }

  .section-title{ display:flex; align-items:center; justify-content:space-between; gap:8px; }

  .stat-grid{
    display:grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap:8px;
  }
  .stat-pill{ background:#0d1020; border:1px solid #2a2f53; border-radius:10px; padding:8px; text-align:center; }
  .stat-pill b{ display:block; font-size:12px; color:var(--muted); }
  .stat-pill span{ font-size:16px; }

  .rarity-chip{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; color:white;
    border:1px solid rgba(255,255,255,.25); font-weight:600; letter-spacing:.2px;
    filter: saturate(1.1);
  }

  .card{
    display:flex; gap:12px; background:#0b0e1e; border:1px solid #232744; border-radius:16px; padding:10px;
    align-items: center;
  }
  .card img{
    width:72px; height:72px; border-radius:10px; object-fit:cover; border: 2px solid #2a2f53;
  }
  .card .meta{ flex:1; }
  .card .meta h4{ margin:4px 0 3px; }
  .card .meta .small{ color:var(--muted); font-size:12px; }
  .card .qty{ text-align:right; }

  .pill{
    font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2a2f53; color:var(--muted);
  }

  .flex-between{ display:flex; align-items:center; justify-content:space-between; gap:8px; }

  .log{
    max-height: 220px; overflow:auto; background:#0b0f1f; border:1px dashed #2b3153; border-radius:12px; padding:10px; font-size:13px;
  }
  .log p{ margin: 8px 0; }
  .log img{ width:20px; height:20px; border-radius:4px; vertical-align:middle; margin-right:6px; object-fit:cover; }

  details summary{ cursor:pointer; padding:6px 0; color:var(--muted); }

  .hr{ height:1px; background:#232744; border:none; margin:10px 0; }

  .hidden{ display:none !important; }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="flex-between">
      <h1>Ultra‑Editable Gacha</h1>
      <div class="row" style="justify-content: flex-end;">
        <span id="currencyDisplay" class="pill">Currency: 0</span>
        <button class="btn soft" id="grant1000">+1,000</button>
        <button class="btn soft" id="exportBtn">Export</button>
        <input type="file" id="importFile" accept="application/json" class="hidden" />
        <button class="btn soft" id="importBtn">Import</button>
        <button class="btn danger" id="resetBtn">Reset</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <div>Pull Cost:
        <input id="pullCost" type="number" min="1" value="100" style="width:100px;margin-left:6px;">
      </div>
      <div>10x Discount (%):
        <input id="tenxDiscount" type="number" min="0" max="100" value="10" style="width:100px;margin-left:6px;">
      </div>
      <div>Currency Name:
        <input id="currencyName" type="text" value="Gems" style="width:120px;margin-left:6px;">
      </div>
      <button class="btn" id="saveEconomy">Save Economy</button>
    </div>
  </div>
</header>

<div class="wrap" style="padding-top: 10px;">
  <div class="tabs" id="tabs">
    <button class="tab-btn active" data-tab="play">Play</button>
    <button class="tab-btn" data-tab="manager">Manager</button>
    <button class="tab-btn" data-tab="rarities">Rarities</button>
    <button class="tab-btn" data-tab="inventory">Inventory</button>
  </div>

  <!-- PLAY TAB -->
  <div class="panel" data-tabcontent="play">
    <div class="grid cols-2">
      <div class="panel">
        <div class="section-title">
          <h2>Gacha Machine</h2>
          <div class="row" style="flex-wrap: nowrap;">
            <button class="btn" id="pull1">Pull x1</button>
            <button class="btn" id="pull10">Pull x10</button>
          </div>
        </div>
        <div class="row">
          <label style="flex:1;">Banner Pool
            <select id="bannerRarityFilter">
              <option value="all">All rarities</option>
            </select>
          </label>
          <label style="flex:1;">Guarantee min rarity (pity):
            <select id="pityMin">
              <option value="">None</option>
            </select>
          </label>
        </div>
        <div class="hr"></div>
        <div id="results" class="grid"></div>
      </div>

      <div class="panel">
        <div class="section-title">
          <h2>Activity Log</h2>
          <button class="btn soft" id="clearLog">Clear</button>
        </div>
        <div id="log" class="log"></div>
        <details>
          <summary>Drop Table (live)</summary>
          <div id="dropTable"></div>
        </details>
      </div>
    </div>
  </div>

  <!-- MANAGER TAB -->
  <div class="panel hidden" data-tabcontent="manager">
    <div class="grid cols-2">
      <div class="panel">
        <h2>Add / Edit Character</h2>
        <div class="grid">
          <label>Name <input id="cName" placeholder="e.g., Emberblade"/></label>
          <label>Image URL <input id="cImg" placeholder="https://..."/></label>
          <div class="row">
            <label style="flex:1;">Rarity
              <select id="cRarity"></select>
            </label>
            <label style="flex:1;">Character Weight
              <input id="cWeight" type="number" min="1" value="1"/>
            </label>
          </div>
          <div class="stat-grid">
            <div class="stat-pill"><b>STR</b><span><input type="number" id="statSTR" value="10"></span></div>
            <div class="stat-pill"><b>DEX</b><span><input type="number" id="statDEX" value="10"></span></div>
            <div class="stat-pill"><b>CON</b><span><input type="number" id="statCON" value="10"></span></div>
            <div class="stat-pill"><b>INT</b><span><input type="number" id="statINT" value="10"></span></div>
            <div class="stat-pill"><b>WIS</b><span><input type="number" id="statWIS" value="10"></span></div>
            <div class="stat-pill"><b>CHA</b><span><input type="number" id="statCHA" value="10"></span></div>
          </div>
          <div class="row">
            <button class="btn soft" id="rollStats">Auto‑Roll DnD (3d6)</button>
            <button class="btn" id="saveChar">Save Character</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Character List</h2>
        <div id="charList"></div>
      </div>
    </div>
  </div>

  <!-- RARITIES TAB -->
  <div class="panel hidden" data-tabcontent="rarities">
    <div class="grid">
      <h2>Rarities (13) & Weights</h2>
      <p>Edit names, gradients, and base weights. Rarity drop is rolled first; character is chosen from within that rarity by character weight.</p>
      <div id="rarityList" class="grid"></div>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="saveRarities">Save Rarities</button>
        <button class="btn soft" id="rebalanceWeights">Normalize Weights</button>
      </div>
    </div>
  </div>

  <!-- INVENTORY TAB -->
  <div class="panel hidden" data-tabcontent="inventory">
    <div class="section-title">
      <h2>Inventory</h2>
      <div class="row" style="flex-wrap: nowrap;">
        <button class="btn soft" id="sortByRarity">Sort by Rarity</button>
        <button class="btn soft" id="sortByName">Sort by Name</button>
      </div>
    </div>
    <div id="inventoryList" class="grid"></div>
  </div>
</div>

<script>
(function(){
  // ---------- Data Model & Persistence ----------
  const defaultRarities = [
    { id:"common",       name:"Common",       gradient:"linear-gradient(135deg,#616f8a,#8896b3)", weight: 400 },
    { id:"uncommon",     name:"Uncommon",     gradient:"linear-gradient(135deg,#2bc0e4,#eaecc6)", weight: 260 },
    { id:"rare",         name:"Rare",         gradient:"linear-gradient(135deg,#1e3c72,#2a5298)", weight: 150 },
    { id:"srare",        name:"Super Rare",   gradient:"linear-gradient(135deg,#7f00ff,#e100ff)", weight: 80 },
    { id:"epic",         name:"Epic",         gradient:"linear-gradient(135deg,#ff9966,#ff5e62)", weight: 50 },
    { id:"mythic",       name:"Mythic",       gradient:"linear-gradient(135deg,#00c6ff,#0072ff)", weight: 30 },
    { id:"legendary",    name:"Legendary",    gradient:"linear-gradient(135deg,#f7971e,#ffd200)", weight: 15 },
    { id:"ancient",      name:"Ancient",      gradient:"linear-gradient(135deg,#bdc3c7,#2c3e50)", weight: 7 },
    { id:"cosmic",       name:"Cosmic",       gradient:"linear-gradient(135deg,#DA22FF,#9733EE)", weight: 4 },
    { id:"divine",       name:"Divine",       gradient:"linear-gradient(135deg,#F3904F,#3B4371)", weight: 2.5 },
    { id:"exalted",      name:"Exalted",      gradient:"linear-gradient(135deg,#FC466B,#3F5EFB)", weight: 1.5 },
    { id:"transcendent", name:"Transcendent", gradient:"linear-gradient(135deg,#00F260,#0575E6)", weight: 0.8 },
    { id:"celestial",    name:"Celestial",    gradient:"linear-gradient(135deg,#f953c6,#b91d73)", weight: 0.2 },
  ];

  const defaultEconomy = {
    currencyName: "Gems",
    balance: 0,
    pullCost: 100,
    tenxDiscount: 10
  };

  function loadState(){
    try{
      const raw = localStorage.getItem("gacha_state_v1");
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){ console.warn(e); return null; }
  }
  function saveState(){
    localStorage.setItem("gacha_state_v1", JSON.stringify(state));
    refreshUI();
  }

  let state = loadState() || {
    rarities: defaultRarities,
    economy: defaultEconomy,
    characters: [], // {id, name, img, rarityId, weight, stats:{STR,DEX,CON,INT,WIS,CHA}}
    inventory: {}   // id -> qty
  };

  // ---------- Helpers ----------
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function uid(){ return Math.random().toString(36).slice(2,9); }

  function getRarityById(id){ return state.rarities.find(r => r.id === id); }

  function formatGradientChip(rarity){
    const el = document.createElement("span");
    el.className = "rarity-chip";
    el.style.background = rarity.gradient;
    el.innerHTML = `<span style="width:10px;height:10px;border-radius:99px;background:rgba(255,255,255,.8);display:inline-block;"></span> ${rarity.name}`;
    return el;
  }

  function totalRarityWeight(){
    return state.rarities.reduce((a,r)=>a+Number(r.weight||0),0);
  }

  function currency(amount){ return `${state.economy.currencyName} ${amount}`; }

  function addLog(html){
    const p = document.createElement("p");
    p.innerHTML = html;
    $("#log").prepend(p);
  }

  function rollRarity(minRarityId=null){
    // If pity sets minimum, collapse weights below min to zero
    const minIndex = minRarityId ? state.rarities.findIndex(r=>r.id===minRarityId) : -1;
    const weights = state.rarities.map((r, i) => (minIndex >=0 && i<minIndex) ? 0 : Number(r.weight||0));
    const sum = weights.reduce((a,b)=>a+b,0);
    let x = Math.random()*sum;
    for(let i=0;i<weights.length;i++){
      x -= weights[i];
      if(x<=0) return state.rarities[i];
    }
    return state.rarities[state.rarities.length-1];
  }

  function pickCharacter(rarityId){
    const pool = state.characters.filter(c=>c.rarityId===rarityId);
    if(pool.length===0) return null;
    const weights = pool.map(c=>Number(c.weight||1));
    const sum = weights.reduce((a,b)=>a+b,0);
    let x = Math.random()*sum;
    for(let i=0;i<pool.length;i++){
      x -= weights[i];
      if(x<=0) return pool[i];
    }
    return pool[pool.length-1];
  }

  function ensureBannerFilters(){
    // Populate rarity filter + pity menu
    const bannerSel = $("#bannerRarityFilter");
    bannerSel.innerHTML = `<option value="all">All rarities</option>`;
    state.rarities.forEach(r=>{
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = r.name;
      bannerSel.appendChild(opt);
    });

    const pitySel = $("#pityMin");
    pitySel.innerHTML = `<option value="">None</option>`;
    state.rarities.forEach(r=>{
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = r.name + " +";
      pitySel.appendChild(opt);
    });
  }

  function renderDropTable(){
    const total = totalRarityWeight();
    const container = $("#dropTable");
    container.innerHTML = "";
    state.rarities.forEach(r=>{
      const pct = total ? ((r.weight/total)*100).toFixed(3) : 0;
      const row = document.createElement("div");
      row.className = "card";
      const chip = formatGradientChip(r);
      row.appendChild(chip);
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `<div class="small">Weight: <b>${r.weight}</b> • Drop Rate: <b>${pct}%</b> • Characters in pool: <b>${state.characters.filter(c=>c.rarityId===r.id).length}</b></div>`;
      row.appendChild(meta);
      container.appendChild(row);
    });
  }

  function renderResults(cards){
    const area = $("#results");
    area.innerHTML = "";
    area.className = "grid cols-3";
    cards.forEach(c=>{
      const rarity = getRarityById(c.rarityId) || {name:"Unknown", gradient:"linear-gradient(45deg,#444,#111)"};
      const card = document.createElement("div");
      card.className = "panel";
      card.style.border = "2px solid rgba(255,255,255,.08)";
      card.style.background = "#0c1125";
      card.innerHTML = `
        <div class="card">
          <img src="${c.img || ""}" onerror="this.src=''; this.style.background='#10142a';" alt=""/>
          <div class="meta">
            <h4>${c.name || "Unknown"}</h4>
            <div class="small"></div>
          </div>
          <div class="qty">
            <span class="rarity-chip" style="background:${rarity.gradient}">${rarity.name}</span>
          </div>
        </div>
        <div class="stat-grid" style="margin-top:8px;">
          ${["STR","DEX","CON","INT","WIS","CHA"].map(k=>`<div class="stat-pill"><b>${k}</b><span>${c.stats?.[k] ?? "-"}</span></div>`).join("")}
        </div>
      `;
      area.appendChild(card);
    });
  }

  function renderCharList(){
    const host = $("#charList");
    host.innerHTML = "";
    const byRarity = {};
    state.characters.forEach(c=>{
      byRarity[c.rarityId] = byRarity[c.rarityId] || [];
      byRarity[c.rarityId].push(c);
    });

    state.rarities.forEach(r=>{
      const group = document.createElement("div");
      group.className = "panel";
      const header = document.createElement("div");
      header.className = "section-title";
      header.innerHTML = `<h3>${r.name}</h3><span class="pill">In pool: ${ (byRarity[r.id]||[]).length }</span>`;
      group.appendChild(header);

      (byRarity[r.id]||[]).forEach(c=>{
        const row = document.createElement("div");
        row.className = "card";
        row.innerHTML = `
          <img src="${c.img || ""}" onerror="this.src=''; this.style.background='#10142a';" alt=""/>
          <div class="meta">
            <h4>${c.name}</h4>
            <div class="small">Weight: ${c.weight} • ${["STR","DEX","CON","INT","WIS","CHA"].map(k=>`${k}:${c.stats[k]}`).join("  ")}</div>
          </div>
        `;
        const controls = document.createElement("div");
        controls.className = "row";
        const edit = document.createElement("button");
        edit.className = "btn soft";
        edit.textContent = "Edit";
        edit.onclick = () => fillEditor(c);
        const del = document.createElement("button");
        del.className = "btn danger";
        del.textContent = "Delete";
        del.onclick = () => {
          if(confirm("Delete character?")){
            state.characters = state.characters.filter(x=>x.id!==c.id);
            saveState();
            renderCharList();
            renderDropTable();
            refreshInventory();
          }
        };
        controls.appendChild(edit);
        controls.appendChild(del);
        row.appendChild(controls);
        group.appendChild(row);
      });

      host.appendChild(group);
    });
  }

  function renderRaritiesEditor(){
    const host = $("#rarityList");
    host.innerHTML = "";
    state.rarities.forEach((r, i)=>{
      const row = document.createElement("div");
      row.className = "card";
      row.style.alignItems = "stretch";
      const chip = formatGradientChip(r);
      row.appendChild(chip);
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <div class="row">
          <label style="flex:1;">Name <input data-field="name" data-id="${r.id}" value="${r.name}"></label>
          <label style="flex:1;">ID <input data-field="id" data-id="${r.id}" value="${r.id}"></label>
          <label style="flex:1;">Gradient CSS <input data-field="gradient" data-id="${r.id}" value="${r.gradient}"></label>
          <label style="flex:1;">Weight <input type="number" step="0.1" data-field="weight" data-id="${r.id}" value="${r.weight}"></label>
        </div>
      `;
      row.appendChild(meta);
      host.appendChild(row);
    });
  }

  function refreshInventory(sortBy="rarity"){
    const host = $("#inventoryList");
    host.innerHTML = "";
    const items = state.characters.map(c=>({c, qty: state.inventory[c.id]||0})).filter(x=>x.qty>0);
    const rarityOrder = state.rarities.map(r=>r.id);
    if(sortBy==="rarity"){
      items.sort((a,b)=> rarityOrder.indexOf(a.c.rarityId) - rarityOrder.indexOf(b.c.rarityId) || a.c.name.localeCompare(b.c.name));
    }else if(sortBy==="name"){
      items.sort((a,b)=> a.c.name.localeCompare(b.c.name));
    }
    items.forEach(({c, qty})=>{
      const r = getRarityById(c.rarityId);
      const row = document.createElement("div");
      row.className = "card";
      row.innerHTML = `
        <img src="${c.img || ""}" onerror="this.src=''; this.style.background='#10142a';" alt=""/>
        <div class="meta">
          <h4>${c.name}</h4>
          <div class="small">${r ? r.name : "Unknown"} • Weight ${c.weight}</div>
        </div>
        <div class="qty">
          <div class="rarity-chip" style="background:${r?.gradient || 'linear-gradient(45deg,#333,#111)'}">${qty} owned</div>
        </div>
      `;
      host.appendChild(row);
    });
  }

  function fillEditor(c){
    $("#cName").value = c.name;
    $("#cImg").value = c.img || "";
    $("#cRarity").value = c.rarityId;
    $("#cWeight").value = c.weight || 1;
    $("#statSTR").value = c.stats?.STR ?? 10;
    $("#statDEX").value = c.stats?.DEX ?? 10;
    $("#statCON").value = c.stats?.CON ?? 10;
    $("#statINT").value = c.stats?.INT ?? 10;
    $("#statWIS").value = c.stats?.WIS ?? 10;
    $("#statCHA").value = c.stats?.CHA ?? 10;
    $("#saveChar").dataset.editingId = c.id;
  }

  function clearEditor(){
    $("#cName").value = "";
    $("#cImg").value = "";
    $("#cRarity").value = state.rarities[0]?.id || "";
    $("#cWeight").value = 1;
    ["STR","DEX","CON","INT","WIS","CHA"].forEach(k=>$("#stat"+k).value = 10);
    delete $("#saveChar").dataset.editingId;
  }

  function refreshEconomyUI(){
    $("#currencyDisplay").textContent = `${state.economy.currencyName}: ${state.economy.balance}`;
    $("#pullCost").value = state.economy.pullCost;
    $("#tenxDiscount").value = state.economy.tenxDiscount;
    $("#currencyName").value = state.economy.currencyName;
  }

  function refreshUI(){
    refreshEconomyUI();
    ensureBannerFilters();
    renderDropTable();
    renderCharList();
    renderRaritiesEditor();
    refreshInventory();
    // Populate rarity select for character editor
    const rsel = $("#cRarity");
    rsel.innerHTML = "";
    state.rarities.forEach(r=>{
      const opt = document.createElement("option");
      opt.value = r.id; opt.textContent = r.name;
      rsel.appendChild(opt);
    });
    // Play tab pity ensures rarities are current
    const pitySel = $("#pityMin");
    pitySel.value = "";
    // Currency pill label
    $("#currencyDisplay").textContent = `${state.economy.currencyName}: ${state.economy.balance}`;
  }

  // ---------- Gacha Actions ----------
  function canAfford(cost){ return state.economy.balance >= cost; }
  function spend(cost){ state.economy.balance -= cost; }

  function doPulls(n){
    const filter = $("#bannerRarityFilter").value;
    const pity = $("#pityMin").value || null;

    const results = [];
    for(let i=0;i<n;i++){
      // Roll rarity with optional pity
      let rarity = rollRarity(pity);
      if(filter !== "all"){
        // If filtered, re-roll until rarity matches filter (cost still applies)
        let safety = 1000;
        while(rarity.id !== filter && safety-->0){
          rarity = rollRarity(pity);
        }
      }
      const char = pickCharacter(rarity.id);
      if(!char){
        addLog(`No character exists for rarity <b>${rarity.name}</b>. Add some in Manager.`);
        continue;
      }
      results.push(char);
      state.inventory[char.id] = (state.inventory[char.id]||0) + 1;
    }
    saveState();
    renderResults(results);
    // Log
    results.forEach(c=>{
      const r = getRarityById(c.rarityId);
      addLog(`<img src="${c.img||''}" onerror="this.src='';">Pulled <b>${c.name}</b> <span class="rarity-chip" style="background:${r?.gradient}">${r?.name||"?"}</span>`);
    });
    refreshInventory();
  }

  // ---------- UI Wiring ----------
  // Tabs
  $$("#tabs .tab-btn").forEach(btn=>{
    btn.addEventListener("click", e=>{
      $$("#tabs .tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      $$("[data-tabcontent]").forEach(p=>p.classList.add("hidden"));
      $$(`[data-tabcontent="${tab}"]`).forEach(p=>p.classList.remove("hidden"));
    });
  });

  // Pull buttons
  $("#pull1").addEventListener("click", ()=>{
    const cost = state.economy.pullCost;
    if(!canAfford(cost)) return alert("Not enough currency.");
    spend(cost); saveState();
    doPulls(1);
  });
  $("#pull10").addEventListener("click", ()=>{
    const base = state.economy.pullCost * 10;
    const discount = Math.min(100, Math.max(0, Number(state.economy.tenxDiscount||0)));
    const cost = Math.floor(base * (1 - discount/100));
    if(!canAfford(cost)) return alert("Not enough currency.");
    spend(cost); saveState();
    doPulls(10);
  });

  // Clear Log
  $("#clearLog").addEventListener("click", ()=> $("#log").innerHTML = "" );

  // Economy save
  $("#saveEconomy").addEventListener("click", ()=>{
    state.economy.pullCost = Math.max(1, Number($("#pullCost").value||1));
    state.economy.tenxDiscount = Math.max(0, Math.min(100, Number($("#tenxDiscount").value||0)));
    state.economy.currencyName = $("#currencyName").value || "Gems";
    saveState();
    addLog(`Saved economy. Pull cost: <b>${currency(state.economy.pullCost)}</b>, 10x discount: <b>${state.economy.tenxDiscount}%</b>.`);
  });

  // Currency grant
  $("#grant1000").addEventListener("click", ()=>{
    state.economy.balance += 1000;
    saveState();
    addLog(`Granted <b>${currency(1000)}</b>.`);
  });

  // Rarities editor save
  $("#saveRarities").addEventListener("click", ()=>{
    // Read edits
    const rows = $$("#rarityList [data-field='name']");
    const next = state.rarities.map(r=>({...r}));
    rows.forEach(input=>{
      const id = input.dataset.id;
      const r = next.find(x=>x.id===id);
      if(r) r.name = input.value;
    });
    $$("#rarityList [data-field='id']").forEach(input=>{
      const oldId = input.dataset.id;
      const r = next.find(x=>x.id===oldId);
      if(r){
        const newId = input.value.trim() || oldId;
        // Update character references
        state.characters.forEach(c=>{ if(c.rarityId===r.id) c.rarityId = newId; });
        r.id = newId;
      }
    });
    $$("#rarityList [data-field='gradient']").forEach(input=>{
      const id = input.dataset.id;
      const r = next.find(x=>x.id===id);
      if(r) r.gradient = input.value;
    });
    $$("#rarityList [data-field='weight']").forEach(input=>{
      const id = input.dataset.id;
      const r = next.find(x=>x.id===id);
      if(r) r.weight = Number(input.value || 0);
    });
    state.rarities = next;
    saveState();
    renderRaritiesEditor();
    ensureBannerFilters();
    renderDropTable();
    refreshInventory();
    addLog("Saved rarities & weights.");
  });

  // Normalize weights to sum=1000
  $("#rebalanceWeights").addEventListener("click", ()=>{
    const total = totalRarityWeight();
    const target = 1000;
    if(total<=0) return alert("Total weight must be > 0.");
    state.rarities.forEach(r=> r.weight = Number(((r.weight/total)*target).toFixed(3)) );
    saveState();
    renderRaritiesEditor();
    renderDropTable();
    addLog("Normalized weights to sum = 1000.");
  });

  // Character editor
  function readStats(){
    const keys = ["STR","DEX","CON","INT","WIS","CHA"];
    const obj = {};
    keys.forEach(k=> obj[k] = Number($("#stat"+k).value||10) );
    return obj;
  }

  $("#rollStats").addEventListener("click", ()=>{
    // 3d6 roll
    const roll3d6 = ()=> Math.floor(Math.random()*6+1) + Math.floor(Math.random()*6+1) + Math.floor(Math.random()*6+1);
    $("#statSTR").value = roll3d6();
    $("#statDEX").value = roll3d6();
    $("#statCON").value = roll3d6();
    $("#statINT").value = roll3d6();
    $("#statWIS").value = roll3d6();
    $("#statCHA").value = roll3d6();
  });

  $("#saveChar").addEventListener("click", ()=>{
    const name = $("#cName").value.trim();
    const img = $("#cImg").value.trim();
    const rarityId = $("#cRarity").value;
    const weight = Math.max(1, Number($("#cWeight").value||1));
    if(!name || !rarityId) return alert("Name and rarity are required.");
    const stats = readStats();
    const editingId = $("#saveChar").dataset.editingId;

    if(editingId){
      const idx = state.characters.findIndex(c=>c.id===editingId);
      if(idx>=0){
        state.characters[idx] = {...state.characters[idx], name, img, rarityId, weight, stats};
        addLog(`Updated character <b>${name}</b>.`);
      }
    }else{
      state.characters.push({ id: uid(), name, img, rarityId, weight, stats });
      addLog(`Added character <b>${name}</b> to pool.`);
    }
    clearEditor();
    saveState();
    renderCharList();
    renderDropTable();
  });

  // Inventory sorting
  $("#sortByRarity").addEventListener("click", ()=> refreshInventory("rarity"));
  $("#sortByName").addEventListener("click", ()=> refreshInventory("name"));

  // Export / Import / Reset
  $("#exportBtn").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "gacha_export.json";
    a.click();
    URL.revokeObjectURL(url);
  });
  $("#importBtn").addEventListener("click", ()=> $("#importFile").click() );
  $("#importFile").addEventListener("change", (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(reader.result);
        // very light validation
        if(!obj.rarities || !obj.economy || !obj.characters || obj.inventory===undefined) throw new Error("Invalid file");
        state = obj;
        saveState();
        addLog("Imported data.");
      }catch(err){
        alert("Import failed: " + err.message);
      }
    };
    reader.readAsText(file);
  });

  $("#resetBtn").addEventListener("click", ()=>{
    if(!confirm("Reset all data? This clears localStorage.")) return;
    localStorage.removeItem("gacha_state_v1");
    state = {
      rarities: JSON.parse(JSON.stringify(defaultRarities)),
      economy: JSON.parse(JSON.stringify(defaultEconomy)),
      characters: [],
      inventory: {}
    };
    saveState();
    addLog("Reset complete.");
    clearEditor();
  });

  // First paint
  refreshUI();
  clearEditor();
})();
</script>
</body>
</html>
